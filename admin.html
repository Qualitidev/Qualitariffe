<!doctype html><html lang="fr"><head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin ‚Äî Qualitariffe</title>
  <style>
    :root { --accent: #7c3aed; --bg: #f8fafc; --text: #1e293b; }
    body { font-family: system-ui, -apple-system, sans-serif; max-width: 1100px; margin: 24px auto; padding: 0 16px; background: var(--bg); color: var(--text); }
    header { display:flex; align-items:center; justify-content:space-between; margin-bottom: 30px; }
    .card { background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
    label { display: block; font-size: 13px; font-weight: 600; margin-top: 12px; color: #64748b; }
    input, select { width: 100%; padding: 10px; border:1px solid #cbd5e1; border-radius: 8px; margin-top: 4px; box-sizing: border-box; font-size: 14px; }
    button { padding: 10px 18px; border:0; border-radius: 8px; cursor:pointer; font-weight: 600; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
    button.primary { background: var(--accent); color:white; }
    button.ghost { background:#f1f5f9; color: #475569; }
    button.outline { background: transparent; border: 1px solid #cbd5e1; color: var(--text); }
    table { width:100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border-bottom: 1px solid #f1f5f9; padding: 14px; text-align:left; }
    .pill { padding: 4px 10px; border-radius: 999px; font-size: 11px; font-weight: 700; }
    .pill.on { background:#dcfce7; color:#166534; }
    .pill.off { background:#fee2e2; color:#991b1b; }
    #drawer { position: fixed; top: 0; right: -450px; width: 400px; height: 100%; background: white; box-shadow: -5px 0 15px rgba(0,0,0,0.1); transition: 0.3s; z-index: 1000; padding: 30px; overflow-y: auto; }
    #drawer.open { right: 0; }
    #overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.3); display:none; z-index: 999; backdrop-filter: blur(2px); }
  </style>
</head>
<body>

<div id="overlay"></div>

<div id="drawer">
  <h2 id="drawerTitle">√âdition Offre</h2>
  <form id="offerForm">
    <input type="hidden" id="f_id">
    
    <label>Titre (SEO)</label>
    <input type="text" id="f_title" required>

    <label>Op√©rateur</label>
    <select id="f_operator" required>
        <option value="">Chargement...</option>
    </select>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 15px;">
      <div>
        <label>Prix (‚Ç¨/mois)</label>
        <input type="number" step="0.01" id="f_price" required>
      </div>
      <div>
        <label>Data IT (GB)</label>
        <input type="number" id="f_giga_it">
      </div>
    </div>

    <label>Lien CTA (cta_url)</label>
    <input type="url" id="f_link" placeholder="https://..." required>

    <div style="margin-top: 30px; display: flex; gap: 10px;">
      <button type="submit" class="primary" style="flex:1">Sauvegarder</button>
      <button type="button" class="outline" onclick="closeDrawer()">Annuler</button>
    </div>
  </form>
</div>

<header>
  <h1>Admin Qualitariffe</h1>
  <div style="display:flex; gap:10px;">
    <button id="btnNew" class="primary" style="display:none;">+ Nouvelle Offre</button>
    <button id="btnLogout" class="ghost" style="display:none;">Logout</button>
  </div>
</header>

<div id="authCard" class="card" style="max-width: 400px; margin: auto;">
  <h2>Login</h2>
  <input id="email" type="email" placeholder="Email">
  <input id="password" type="password" placeholder="Pass">
  <button id="btnLogin" class="primary" style="width:100%; margin-top:10px;">Entrer</button>
  <p id="authMsg" style="color:red;"></p>
</div>

<div id="appCard" style="display:none;">
  <div class="card"><div id="tableWrap"></div></div>
</div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const supabaseUrl = "https://ytlpotajswovxwzxrmvu.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl0bHBvdGFqc3dvdnh3enhybXZ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4MTU3MDgsImV4cCI6MjA4NjM5MTcwOH0.k02CzC7bj_NlXVZs-jV69djujHqrFm5sCDKWDN-EExA"; 
  const _supabase = createClient(supabaseUrl, supabaseKey);

  const $ = (id) => document.getElementById(id);

  // Charger les op√©rateurs pour le Select
  async function loadOperators() {
    const { data } = await _supabase.from("operators").select("id, name");
    if (data) {
        $("f_operator").innerHTML = data.map(op => `<option value="${op.id}">${op.name}</option>`).join("");
    }
  }

  function openDrawer(offer = null) {
    $("drawer").classList.add("open");
    $("overlay").style.display = "block";
    if (offer) {
      $("f_id").value = offer.id;
      $("f_title").value = offer.title;
      $("f_operator").value = offer.operator_id;
      $("f_price").value = offer.price_eur;
      $("f_giga_it").value = offer.giga_it;
      $("f_link").value = offer.cta_url; // Align√© sur ton SQL
    } else {
      $("offerForm").reset();
      $("f_id").value = "";
    }
  }

  window.closeDrawer = () => { $("drawer").classList.remove("open"); $("overlay").style.display = "none"; };
  $("overlay").onclick = closeDrawer;
  $("btnNew").onclick = () => openDrawer();

  async function refreshOffers() {
    const { data } = await _supabase.from("offers").select("*").order("created_at", { ascending: false });
    window.currentData = data;
    $("tableWrap").innerHTML = `<table><thead><tr><th>Offre</th><th>Prix</th><th>Statut</th><th>Actions</th></tr></thead>
      <tbody>${data.map(o => `<tr>
        <td><strong>${o.title}</strong><br><small>${o.operator_id}</small></td>
        <td>${o.price_eur}‚Ç¨</td>
        <td>${o.active ? '<span class="pill on">ON</span>' : '<span class="pill off">OFF</span>'}</td>
        <td>
            <button class="outline" onclick="window.editOffer('${o.id}')">‚úèÔ∏è</button>
            <button class="ghost" onclick="window.deleteOffer('${o.id}')">üóëÔ∏è</button>
        </td>
      </tr>`).join("")}</tbody></table>`;
  }

  window.editOffer = (id) => openDrawer(window.currentData.find(x => x.id === id));
  
  window.deleteOffer = async (id) => {
      if(confirm("Supprimer ?")) {
          await _supabase.from("offers").delete().eq("id", id);
          refreshOffers();
      }
  };

  $("offerForm").onsubmit = async (e) => {
    e.preventDefault();
    const id = $("f_id").value;
    const payload = {
      title: $("f_title").value,
      operator_id: $("f_operator").value,
      price_eur: parseFloat($("f_price").value),
      giga_it: parseInt($("f_giga_it").value) || 0,
      cta_url: $("f_link").value, // Sync avec SQL
      active: true
    };

    const res = id ? await _supabase.from("offers").update(payload).eq("id", id) 
                   : await _supabase.from("offers").insert([payload]);

    if (res.error) alert(res.error.message);
    else { closeDrawer(); refreshOffers(); }
  };

  async function setUi(session) {
    const isLogged = !!session;
    $("authCard").style.display = isLogged ? "none" : "block";
    $("appCard").style.display = isLogged ? "block" : "none";
    $("btnLogout").style.display = $("btnNew").style.display = isLogged ? "inline-flex" : "none";
    if (isLogged) { loadOperators(); refreshOffers(); }
  }

  $("btnLogin").onclick = async () => {
    const { error } = await _supabase.auth.signInWithPassword({ email: $("email").value, password: $("password").value });
    if (error) $("authMsg").textContent = error.message;
  };

  $("btnLogout").onclick = async () => await _supabase.auth.signOut();
  _supabase.auth.onAuthStateChange((_event, session) => setUi(session));
  const { data: { session } } = await _supabase.auth.getSession();
  setUi(session);
</script>
</body></html>
