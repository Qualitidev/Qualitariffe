<!doctype html><html lang="fr"><head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — Qualitariffe</title>
  <style>
    :root { --accent: #111827; --bg: #f9fafb; }
    body { font-family: system-ui, -apple-system, sans-serif; max-width: 1000px; margin: 24px auto; padding: 0 16px; background: var(--bg); color: #1f2937; }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom: 30px; }
    .card { background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    input { width: 100%; padding: 10px; border:1px solid #d1d5db; border-radius: 8px; margin-top: 5px; box-sizing: border-box; }
    button { padding: 10px 16px; border:0; border-radius: 8px; cursor:pointer; font-weight: 600; transition: all 0.2s; }
    button.primary { background: var(--accent); color:white; }
    button.ghost { background:#f3f4f6; color: #4b5563; }
    button:hover { opacity: 0.85; }
    table { width:100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border-bottom: 1px solid #f3f4f6; padding: 12px; text-align:left; }
    th { color: #6b7280; font-size: 12px; text-transform: uppercase; letter-spacing: 0.05em; }
    .muted { color:#6b7280; font-size: 13px; }
    .pill { padding: 4px 10px; border-radius: 999px; font-size: 11px; font-weight: 700; display:inline-block; }
    .pill.on { background:#dcfce7; color:#166534; }
    .pill.off { background:#fee2e2; color:#991b1b; }
  </style></head><body>

<header>
  <div>
    <h1 style="margin:0; font-size: 24px;">Console Admin</h1>
    <div class="muted">Qualitariffe — Gestion des offres</div>
  </div>
  <button id="btnLogout" class="ghost" style="display:none;">Déconnexion</button>
</header>

<div id="authCard" class="card" style="max-width: 400px; margin: 40px auto;">
  <h2 style="margin-top:0;">Connexion</h2>
  <div style="margin-bottom: 15px;">
    <label class="muted">Email</label>
    <input id="email" type="email" placeholder="votre@email.com">
  </div>
  <div style="margin-bottom: 20px;">
    <label class="muted">Mot de passe</label>
    <input id="password" type="password" placeholder="••••••••">
  </div>
  <button id="btnLogin" class="primary" style="width: 100%;">Se connecter</button>
  <p id="authMsg" class="muted" style="text-align: center; margin-top: 15px;"></p>
</div>

<div id="appCard" style="display:none;">
  <div class="card">
    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
      <h2 style="margin:0;">Offres en base</h2>
      <div class="muted" id="countInfo">Chargement...</div>
    </div>
    <div id="tableWrap" style="overflow-x: auto;"></div>
  </div>
</div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const supabaseUrl = "https://ytlpotajswovxwzxrmvu.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl0bHBvdGFqc3dvdnh3enhybXZ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4MTU3MDgsImV4cCI6MjA4NjM5MTcwOH0.k02CzC7bj_NlXVZs-jV69djujHqrFm5sCDKWDN-EExA"; 
  const _supabase = createClient(supabaseUrl, supabaseKey);

  const $ = (id) => document.getElementById(id);

  async function refreshOffers() {
    const { data, error } = await _supabase
      .from("offers")
      .select("*")
      .order("created_at", { ascending: false });

    if (error) {
      $("tableWrap").innerHTML = `<div class="pill off">Erreur : ${error.message}</div>`;
      return;
    }

    $("countInfo").textContent = `${data.length} offres`;

    const rows = data.map(o => `
      <tr>
        <td>
          <div style="font-weight:600">${o.title || 'Sans nom'}</div>
          <div class="muted" style="font-size:10px;">ID: ${o.id}</div>
        </td>
        <td><span class="pill ghost">${o.operator_id}</span></td>
        <td><strong>${o.price_eur} €</strong></td>
        <td>${o.active ? '<span class="pill on">ACTIVE</span>' : '<span class="pill off">OFF</span>'}</td>
        <td>
          <button class="ghost" onclick="window.toggleActive('${o.id}', ${o.active})">
            ${o.active ? 'Désactiver' : 'Activer'}
          </button>
        </td>
      </tr>
    `).join("");

    $("tableWrap").innerHTML = `
      <table>
        <thead>
          <tr>
            <th>Détails</th>
            <th>Opérateur</th>
            <th>Prix</th>
            <th>Statut</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>`;
  }

  window.toggleActive = async (id, currentStatus) => {
    const { error } = await _supabase
      .from("offers")
      .update({ active: !currentStatus })
      .eq("id", id);

    if (error) alert("Erreur RLS : " + error.message);
    else refreshOffers();
  };

  async function setUiForSession(session) {
    const isLogged = !!session;
    $("authCard").style.display = isLogged ? "none" : "block";
    $("appCard").style.display = isLogged ? "block" : "none";
    $("btnLogout").style.display = isLogged ? "inline-block" : "none";
    if (isLogged) refreshOffers();
  }

  $("btnLogin").onclick = async () => {
    const email = $("email").value;
    const password = $("password").value;
    $("authMsg").textContent = "Vérification...";
    const { error } = await _supabase.auth.signInWithPassword({ email, password });
    if (error) $("authMsg").textContent = "❌ " + error.message;
  };

  $("btnLogout").onclick = async () => { await _supabase.auth.signOut(); };

  _supabase.auth.onAuthStateChange((_event, session) => setUiForSession(session));
  
  const { data: { session } } = await _supabase.auth.getSession();
  setUiForSession(session);
</script>
</body></html>
