<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — Qualitariffe</title>
  <style>
    :root {
      --accent: #7c3aed;
      --bg: #f8fafc;
      --text: #0f172a;
      --muted: #64748b;
      --border: #e2e8f0;
      --card: #ffffff;
      --danger-bg: #fee2e2;
      --danger-tx: #991b1b;
      --ok-bg: #dcfce7;
      --ok-tx: #166534;
      --shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
    }

    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      max-width: 1180px;
      margin: 24px auto;
      padding: 0 16px;
    }

    header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 18px;
    }

    .brand h1 { margin:0; font-size: 20px; }
    .brand .sub { color: var(--muted); font-size: 12px; margin-top: 4px; }

    .pill {
      display:inline-flex;
      align-items:center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--muted);
      max-width: 360px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .toolbar { display:flex; align-items:center; gap: 10px; flex-wrap: wrap; justify-content: flex-end; }
    button {
      padding: 10px 14px;
      border: 0;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 650;
      transition: transform 0.12s ease, opacity 0.12s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: #f1f5f9;
      color: #334155;
    }
    button:hover { opacity: .92; transform: translateY(-1px); }
    button.primary { background: var(--accent); color: white; }
    button.outline { background: transparent; border: 1px solid #cbd5e1; color: var(--text); }
    button.ghost { background: #f1f5f9; }
    button.danger { background: var(--danger-bg); color: var(--danger-tx); }
    button.small { padding: 6px 10px; border-radius: 8px; font-size: 12px; font-weight: 700; }

    .tabs {
      display: inline-flex;
      border: 1px solid var(--border);
      background: white;
      border-radius: 12px;
      overflow: hidden;
    }
    .tab {
      border: 0;
      background: transparent;
      padding: 10px 12px;
      cursor: pointer;
      font-weight: 750;
      color: #334155;
    }
    .tab.active { background: #f1f5f9; color: #0f172a; }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 18px;
      box-shadow: var(--shadow);
    }

    label {
      display:block;
      margin-top: 12px;
      font-size: 12px;
      font-weight: 750;
      color: var(--muted);
    }

    input, select {
      width: 100%;
      margin-top: 6px;
      padding: 10px 12px;
      border: 1px solid #cbd5e1;
      border-radius: 10px;
      font-size: 14px;
      background: white;
    }

    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .grid3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    .muted { color: var(--muted); font-size: 12px; }
    .hr { height: 1px; background: #eef2f7; margin: 16px 0; }

    table { width:100%; border-collapse: collapse; margin-top: 12px; }
    th, td { padding: 12px; border-bottom: 1px solid #f1f5f9; text-align:left; vertical-align: top; }
    th {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #94a3b8;
    }

    .status {
      display:inline-block;
      font-size: 11px;
      font-weight: 850;
      padding: 4px 10px;
      border-radius: 999px;
    }
    .on { background: var(--ok-bg); color: var(--ok-tx); }
    .off { background: var(--danger-bg); color: var(--danger-tx); }

    /* Overlay + Drawers */
    #overlay {
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 23, 0.38);
      backdrop-filter: blur(2px);
      display: none;
      z-index: 999;
    }

    .drawer {
      position: fixed;
      top: 0;
      right: -480px;
      width: 440px;
      height: 100%;
      background: white;
      box-shadow: -8px 0 22px rgba(15, 23, 42, 0.18);
      transition: right 0.25s ease;
      z-index: 1000;
      padding: 22px;
      overflow-y: auto;
      border-left: 1px solid var(--border);
    }
    .drawer.open { right: 0; }
    .drawer h2 { margin: 0; font-size: 16px; }
    .drawer .sub { margin-top: 6px; color: var(--muted); font-size: 12px; }

    .drawer .actions { display:flex; gap: 10px; margin-top: 16px; }
    .drawer .actions button { flex: 1; justify-content: center; }

    #authCard { max-width: 420px; margin: 60px auto; }

    @media (max-width: 980px) {
      .grid2, .grid3 { grid-template-columns: 1fr; }
      .drawer { width: 92vw; }
      .pill { max-width: 260px; }
    }

    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }

    pre {
      background: #0b1220;
      color: #e5e7eb;
      padding: 12px;
      border-radius: 12px;
      overflow: auto;
      font-size: 12px;
    }
  </style>
</head>

<body>
  <div id="overlay"></div>

  <div id="drawerOffer" class="drawer">
    <h2 id="drawerOfferTitle">Nouvelle offre</h2>
    <div class="sub">Créer / modifier une offre (table <b>offers</b>)</div>

    <form id="offerForm">
      <input type="hidden" id="offer_id" />

      <label>Active</label>
      <select id="offer_active">
        <option value="true">true</option>
        <option value="false">false</option>
      </select>

      <label>Titre</label>
      <input id="offer_title" placeholder="Ex: Giga 150 5G" required />

      <div class="grid2">
        <div>
          <label>Opérateur</label>
          <select id="offer_operator_id" required></select>
        </div>
        <div>
          <label>Prix (EUR / mois)</label>
          <input id="offer_price_eur" type="number" step="0.01" placeholder="7.99" required />
        </div>
      </div>

      <div class="grid3">
        <div>
          <label>Giga IT</label>
          <input id="offer_giga_it" type="number" placeholder="150" />
        </div>
        <div>
          <label>Roaming UE (GB)</label>
          <input id="offer_giga_eu" type="number" placeholder="10" />
        </div>
        <div>
          <label>Vitesse (Mbps)</label>
          <input id="offer_speed_mbps" type="number" placeholder="300" />
        </div>
      </div>

      <div class="grid3">
        <div>
          <label>Minutes</label>
          <input id="offer_minutes" type="number" placeholder="1000" />
        </div>
        <div>
          <label>SMS</label>
          <input id="offer_sms" type="number" placeholder="200" />
        </div>
        <div>
          <label>Attivazione (EUR)</label>
          <input id="offer_activation_fee_eur" type="number" step="0.01" placeholder="0.00" />
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>SIM (EUR)</label>
          <input id="offer_sim_fee_eur" type="number" step="0.01" placeholder="0.00" />
        </div>
        <div>
          <label>Eligibility mode</label>
          <select id="offer_eligibility_mode">
            <option value="any">any</option>
            <option value="include_only">include_only</option>
            <option value="exclude">exclude</option>
          </select>
        </div>
      </div>

      <label>from_operators (ex: iliad|postemobile)</label>
      <input id="offer_from_operators" placeholder="iliad|postemobile|nuovo_numero" />

      <div class="hr"></div>

      <label>CTA URL (Lien affiliation)</label>
      <input id="offer_cta_url" type="url" placeholder="https://..." required />

      <label>Analysis URL (optionnel)</label>
      <input id="offer_analysis_url" type="url" placeholder="https://...pdf" />

      <div class="actions">
        <button class="primary" type="submit">Enregistrer</button>
        <button class="outline" type="button" id="btnOfferCancel">Annuler</button>
      </div>

      <div class="actions" style="margin-top:10px;">
        <button class="danger" type="button" id="btnOfferDelete" style="display:none;">Supprimer</button>
      </div>

      <p id="offerMsg" class="muted"></p>
    </form>
  </div>

  <div id="drawerOperator" class="drawer">
    <h2 id="drawerOperatorTitle">Nouvel opérateur</h2>
    <form id="operatorForm">
      <label>Operator ID (slug)</label>
      <input id="operator_id" placeholder="ex: iliad" required />

      <label>Nom affiché</label>
      <input id="operator_name" placeholder="ex: iliad" required />

      <label>Réseau hôte (network_id)</label>
      <select id="operator_network_id" required></select>

      <label>Logo URL</label>
      <input id="operator_logo_url" placeholder="https://..." />

      <label>Actif</label>
      <select id="operator_is_active">
        <option value="true">true</option>
        <option value="false">false</option>
      </select>

      <div class="actions">
        <button class="primary" type="submit">Enregistrer</button>
        <button class="outline" type="button" id="btnOperatorCancel">Annuler</button>
      </div>
      <div class="actions" style="margin-top:10px;">
        <button class="danger" type="button" id="btnOperatorDelete" style="display:none;">Supprimer</button>
      </div>
      <p id="operatorMsg" class="muted"></p>
    </form>
  </div>

  <header>
    <div class="brand">
      <h1>Console Admin</h1>
      <div class="sub">Gestion des offres Qualitariffe</div>
    </div>

    <div class="toolbar">
      <div class="tabs" id="tabs" style="display:none;">
        <button class="tab active" id="tabOffers" type="button">Offres</button>
        <button class="tab" id="tabOperators" type="button">Opérateurs</button>
      </div>

      <span id="userEmail" class="pill" style="display:none;"></span>

      <button id="btnNewOffer" class="primary" style="display:none;">+ Nouvelle offre</button>
      <button id="btnNewOperator" class="primary" style="display:none;">+ Nouvel opérateur</button>
      <button id="btnLogout" class="ghost" style="display:none;">Déconnexion</button>
    </div>
  </header>

  <div id="authCard" class="card">
    <h2>Connexion</h2>
    <label>Email</label>
    <input id="email" type="email" placeholder="Email" />
    <label>Mot de passe</label>
    <input id="password" type="password" placeholder="Mot de passe" />
    <div class="hr"></div>
    <button id="btnLogin" class="primary" style="width:100%; justify-content:center;">Se connecter</button>
    <p id="authMsg" class="muted" style="margin-top:10px; color:#b91c1c;"></p>
  </div>

  <div id="appCard" style="display:none;">
    <div class="card">
      <div id="offersView">
        <div style="text-align:right;">
          <button class="outline" id="btnRefreshOffers" type="button">Rafraîchir</button>
        </div>
        <div id="offersWrap" style="overflow-x:auto;"></div>
      </div>

      <div id="operatorsView" style="display:none;">
        <div style="text-align:right;">
          <button class="outline" id="btnRefreshOperators" type="button">Rafraîchir</button>
        </div>
        <div id="operatorsWrap" style="overflow-x:auto;"></div>
      </div>

      <div class="hr"></div>
      <details>
        <summary class="muted" style="cursor:pointer;">Debug</summary>
        <pre id="debug"></pre>
      </details>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://ytlpotajswovxwzxrmvu.supabase.co";
    // TA CLÉ API INTÉGRÉE ICI
    const SUPABASE_PUBLISHABLE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl0bHBvdGFqc3dvdnh3enhybXZ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4MTU3MDgsImV4cCI6MjA4NjM5MTcwOH0.k02CzC7bj_NlXVZs-jV69djujHqrFm5sCDKWDN-EExA"; 

    const supabase = createClient(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY);

    const $ = (id) => document.getElementById(id);
    const setDebug = (obj) => { $("debug").textContent = JSON.stringify(obj, null, 2); };
    const numOrNull = (v) => (v === "" || v === null || v === undefined) ? null : Number(v);
    const textOrNull = (v) => (v && v.trim() !== "") ? v.trim() : null;

    function openDrawer(drawerId) { $("overlay").style.display = "block"; $(drawerId).classList.add("open"); }
    function closeDrawer(drawerId) { $(drawerId).classList.remove("open"); $("overlay").style.display = "none"; }

    $("overlay").onclick = () => { closeDrawer("drawerOffer"); closeDrawer("drawerOperator"); };

    function setTab(tab) {
      const isOff = tab === "offers";
      $("offersView").style.display = isOff ? "block" : "none";
      $("operatorsView").style.display = isOff ? "none" : "block";
      $("tabOffers").classList.toggle("active", isOff);
      $("tabOperators").classList.toggle("active", !isOff);
      $("btnNewOffer").style.display = isOff ? "inline-flex" : "none";
      $("btnNewOperator").style.display = isOff ? "none" : "inline-flex";
    }

    $("tabOffers").onclick = () => setTab("offers");
    $("tabOperators").onclick = () => setTab("operators");

    async function loadNetworksSelect() {
      const { data } = await supabase.from("networks").select("id,name").order("name");
      if (data) $("operator_network_id").innerHTML = data.map(n => `<option value="${n.id}">${n.name}</option>`).join("");
    }

    async function loadOperatorsSelect() {
      const { data } = await supabase.from("operators").select("id,name,is_active").order("name");
      if (data) $("offer_operator_id").innerHTML = data.map(op => `<option value="${op.id}">${op.name}</option>`).join("");
    }

    async function refreshOffers() {
      const { data } = await supabase.from("offers").select("*").order("created_at", { ascending: false });
      window.__offers = data || [];
      $("offersWrap").innerHTML = `<table><thead><tr><th>Offre</th><th>Prix</th><th>Data</th><th>Statut</th><th>Action</th></tr></thead><tbody>
        ${window.__offers.map(o => `<tr><td><strong>${o.title}</strong><br><small>${o.operator_id}</small></td><td>${o.price_eur}€</td><td>${o.giga_it}GB</td><td><span class="status ${o.active?'on':'off'}">${o.active?'ON':'OFF'}</span></td><td><button class="small outline" onclick="window.__editOffer('${o.id}')">✏️</button></td></tr>`).join("")}
      </tbody></table>`;
    }

    window.__editOffer = (id) => {
      const o = window.__offers.find(x => x.id === id);
      $("offer_id").value = o.id;
      $("offer_title").value = o.title;
      $("offer_operator_id").value = o.operator_id;
      $("offer_price_eur").value = o.price_eur;
      $("offer_giga_it").value = o.giga_it;
      $("offer_cta_url").value = o.cta_url;
      $("btnOfferDelete").style.display = "inline-flex";
      openDrawer("drawerOffer");
    };

    $("offerForm").onsubmit = async (e) => {
      e.preventDefault();
      const id = $("offer_id").value;
      const payload = {
        title: $("offer_title").value,
        operator_id: $("offer_operator_id").value,
        price_eur: numOrNull($("offer_price_eur").value),
        giga_it: numOrNull($("offer_giga_it").value),
        cta_url: $("offer_cta_url").value,
        active: $("offer_active").value === "true"
      };
      const res = id ? await supabase.from("offers").update(payload).eq("id", id) : await supabase.from("offers").insert([payload]);
      if (res.error) alert(res.error.message); else { closeDrawer("drawerOffer"); refreshOffers(); }
    };

    // Initialisation Auth
    async function setUi(session) {
      const logged = !!session;
      $("authCard").style.display = logged ? "none" : "block";
      $("appCard").style.display = logged ? "block" : "none";
      $("tabs").style.display = $("btnLogout").style.display = $("userEmail").style.display = logged ? "inline-flex" : "none";
      if (logged) {
        $("userEmail").textContent = session.user.email;
        loadNetworksSelect(); loadOperatorsSelect(); refreshOffers(); setTab("offers");
      }
    }

    $("btnLogin").onclick = async () => {
      const { error } = await supabase.auth.signInWithPassword({ email: $("email").value, password: $("password").value });
      if (error) $("authMsg").textContent = error.message;
    };
    $("btnLogout").onclick = () => supabase.auth.signOut();
    supabase.auth.onAuthStateChange((_event, session) => setUi(session));
    const { data: { session } } = await supabase.auth.getSession();
    setUi(session);
  </script>
</body>
</html>
